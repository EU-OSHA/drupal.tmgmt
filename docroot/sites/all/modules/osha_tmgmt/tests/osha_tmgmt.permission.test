<?php

class OSHATMGMTPermissionTestCase extends OSHATMGMTBaseTestCase {

  static function getInfo() {
    return array(
      'name' => 'Test node add/edit forms ',
      'description' => 'Check translation permissions',
      'group' => 'EU-OSHA',
    );
  }

  /**
   * admin/tmgmt/sources
   */
  function testAccessSourcesScreen() {
    $admin = $this->drupalCreateUser(array(
      'create osha_tmgmt_demo_article content',
      'create translation jobs',
    ));
    $this->drupalLogin($admin);
    $this->createTestNode();

    $this->drupalGet('admin/tmgmt/sources');
    $this->assertText('Content selection', 'Access the node selection screen');

    $this->drupalGet('admin/tmgmt/sources/locale_default');
    $this->assertText('Locale overview (Locale source)', 'Access the literals selection screen');

    $this->drupalGet('admin/tmgmt/sources/i18n_string_menu_link');
    $this->assertText('Menu link overview (i18n String)', 'Access the menu item selection screen');
  }

  /**
   * admin/tmgmt/sources
   */
  function testCreateTranslationJob() {
    $admin = $this->drupalCreateUser(array(
      'create osha_tmgmt_demo_article content',
      'create translation jobs',
      'osha tmgmt view translation job',
    ));
    $this->drupalLogin($admin);
    $this->createTestNode();

    $this->drupalGet('admin/tmgmt/sources');
    $this->assertText('Content selection', 'Access the node selection screen');

    $edit = array(
      'views_bulk_operations[0]' => 1,
    );
    $this->drupalPost('admin/tmgmt/sources', $edit, t('Add to cart (full translation)'));

    $edit = array(
      'items[1]' => 1,
      'target_language[]' => array('de', 'es')
    );
    $this->drupalPost('admin/tmgmt/cart', $edit, t('Create translation job'));

    $this->drupalGet('admin/tmgmt');
    $this->assertText('Translation job #1');

    $this->drupalGet('admin/tmgmt/jobs/1');
    $this->assertNoText('Access denied');
    $this->assertText(OSHA_TMGMT_TEST_TITLE);
  }

  function testNodeTranslationTab() {
    $user = $this->drupalCreateUser(array(
      'create osha_tmgmt_demo_article content',
      'create translation jobs',
      'translate node entities',
    ));
    $this->drupalLogin($user);
    $this->createTestNode();

    $this->drupalGet('node/1/translate');
    $this->assertRaw('Add to cart (full translation)', 'I can add node into cart from the node translation tab');
  }

}
